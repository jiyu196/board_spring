<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{/layout/index :: setContent(~{this::content})}">
  <th:block th:fragment="content">
    <h1>Board Read Page</h1>

    <div class="form-group">
      <label for="bno">bno</label>
      <input type="text" class="form-control" name="bno" placeholder="bno" id="bno" th:value="${dto.bno}" readonly="readonly">
    </div>
    <div class="form-group">
      <label for="title">Title</label>
      <input type="text" class="form-control" name="title" placeholder="title" id="title" th:value="${dto.title}" readonly="readonly">
    </div>
    <div class="form-group">
      <label>Content</label>
      <textarea class="form-control" name="content" placeholder="Content"  readonly="readonly">[[${dto.content}]]</textarea>
    </div>
    <div class="form-group">
      <label>Writer</label>
      <input type="text" class="form-control" name="writer" placeholder="Writer" th:value="${dto.writerName}" readonly="readonly">
    </div>
    <div class="form-group">
      <label>regDate</label>
      <input type="text" class="form-control" name="regDate" placeholder="regDate" th:value="${#temporals.format(dto.regDate, 'yyy/MM/dd')}" readonly="readonly">
    </div>

    <div class="form-group my-4">
      <label>modDate</label>
      <input type="text" class="form-control" name="modDate" placeholder="modDate" th:value="${#temporals.format(dto.modDate, 'yyy/MM/dd')}" readonly="readonly">
    </div>
    <a th:href="@{/board/modify(page = ${requestDto.page}, size = ${requestDto.size}, bno = ${dto.bno}, type = ${requestDto.type}, keyword = ${requestDto.keyword})}" class="btn btn-primary mt-3">Modify</a>
    <a th:href="@{/board/list(page = ${requestDto.page}, size = ${requestDto.size}, type = ${requestDto.type}, keyword = ${requestDto.keyword})}" class="btn btn-primary mt-3">List</a>

    <div class="mt-4">
      <h5><button class="badge bg-info addReply p-2 text-decoration-none text-white border-0">Add Reply</button></h5>
      <h5><button class="badge btn bg-secondary replyCount p-2 text-decoration-none text-white border-0">Reply Count [[${dto.replyCount}]]</button></h5>
      <ul class="list-group replyList">

      </ul>
    </div>
  </th:block>
</th:block>
<!-- The Modal -->
<div class="modal">
  <div class="modal-dialog">
    <div class="modal-content">

      <!-- Modal Header -->
      <div class="modal-header">
        <h4 class="modal-title">Reply</h4>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <!-- Modal body -->
      <div class="modal-body">
        <div class="form-group">
          <input class="form-control replyText" type="text" name="text" placeholder="replyText...">
        </div>
        <div class="form-group my-3">
          <input class="form-control replyReplyer" type="text" name="replyer" placeholder="replyer...">
        </div>

        <input type="hidden" name="rno">
      </div>

      <!-- Modal footer -->
      <div class="modal-footer">
        <button type="button" class="btn btn-danger replyRemove" >Remove</button>
        <button type="button" class="btn btn-warning replyModify" >Modify</button>
        <button type="button" class="btn btn-primary replySave" >Save</button>
        <button type="button" class="btn btn-outline-secondary replyClose" data-bs-dismiss="modal">Close</button>
      </div>

    </div>
  </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.13/dayjs.min.js" integrity="sha512-FwNWaxyfy2XlEINoSnZh1JQ5TRRtGow0D6XcmAWmYCRgvqOUTnzCxPc9uF35u5ZEpirk1uhlPVA19tflhvnW1g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.13/plugin/relativeTime.min.js" integrity="sha512-MVzDPmm7QZ8PhEiqJXKz/zw2HJuv61waxb8XXuZMMs9b+an3LoqOqhOEt5Nq3LY1e4Ipbbd/e+AWgERdHlVgaA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.13/locale/ko.min.js" integrity="sha512-ycjm4Ytoo3TvmzHEuGNgNJYSFHgsw/TkiPrGvXXkR6KARyzuEpwDbIfrvdf6DwXm+b1Y+fx6mo25tBr1Icg7Fw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script th:inline="javascript">
  window.addEventListener("load", e => {
    dayjs.extend(window.dayjs_plugin_relativeTime)
    dayjs.locale('ko')

    const myModal = new bootstrap.Modal(document.querySelector('.modal'))
    const bno = [[${dto.bno}]];
    const listGroup = document.querySelector(".replyList");  //dom으로

    const loadJSONData = () => {
      // e.preventDefault();
      fetch(`../replies/board/${bno}`)
          .then(resp => resp.json())
          .then(arr => {
            console.log(arr);
            // success
            document.querySelector(".replyCount").innerHTML = "Reply Count" + arr.length;  // 객체 내 배열을 문자열로 만들려는거.map을 이용해서 문자열배열로 바꾼

            listGroup.innerHTML = arr.map(r => {
              console.log(r)

              return `
                <li class="card list-group-item" data-rno="${r.rno}"><b>${r.rno}</b>
                 <div class="card-body">
                   <h5 class="card-title">${r.text}</h5>
                   <h5 class="card-subtitle mb-2 text-muted">${r.replyer}</h5>
                   <p class="card-text">${dayjs(r.regDate).fromNow()}</p>
                   <button type="button" class="btn btn-warning replyModify" >Modify</button>
                   <button type="button" class="btn btn-danger replyRemove" >Remove</button>
                 </div>
                </li>
              `;
            }).join("")
          })
    };
    document.querySelector(".replyCount").addEventListener("click",() => loadJSONData());

    document.querySelector(".addReply").addEventListener("click", () => {
      const myModal = new bootstrap.Modal(document.querySelector('.modal'))

      document.querySelectorAll('.card-body input[type=text]').forEach(i => i.value = '');
      [...document.querySelectorAll(".modal-footer button")]
          .filter(b => { b.classList.add('d-none') ; return b.matches('.replyClose, .replySave')})  //close, save만 남기겠다
          .forEach(b => b.classList.remove('d-none'));
      myModal.show()
    });

    document.querySelector(".replyList").addEventListener("click", () => {
      const myModal = new bootstrap.Modal(document.querySelector('.modal'))

      document.querySelectorAll('.card-body input[type=text]').forEach(i => i.value = '');
      [...document.querySelectorAll(".modal-footer button")]
              .filter(b => { b.classList.add('d-none') ; return b.matches('.replyModify, .replyRemove, .replyClose')})
              .forEach(b => b.classList.remove('d-none'));
      myModal.show()
    });



    //save
    // 1
    document.querySelector(".replySave").addEventListener("click", e => {
       console.log("클릭")
      // 2
      const reply = {bno}
      console.log(reply);
      e.target.closest(".modal").querySelectorAll("input[type=text]").forEach(i => reply[i.name] = i.value);
      console.log(reply)

      fetch("/replies", {
        method: "POST",
        headers : {
          "Content-Type" : "application/json"
        },
        body: JSON.stringify(reply)
      })
      .then(resp => resp.json())
      .then(data => {
        alert(data + "번 댓글이 등록되었습니다")
        myModal.hide();
        loadJSONData(e);
      });
    });

    //remove
      // 1
      document.querySelector(".replyRemove").addEventListener("click", e => {
        console.log("삭제버튼 클릭")

      // 2
      //   const rno = {rno};
        const rno = document.querySelector("input[name='rno']").value;
        console.log(rno);
        // e.target.closest(".modal").querySelectorAll("input[type=text]").forEach(i => rno[i.name] = i.value);
        // console.log(rno)

        fetch(`/replies/${rno}`, {
          method: "DELETE",

        })
            .then(resp => resp.json())
            .then(data => {
              alert("댓글이 삭제되었습니다")
              myModal.hide();
              loadJSONData(e);
            });

        })

    //modify
    // 1
    document.querySelector(".replyModify").addEventListener("click", e => {
      console.log("수정버튼클릭")
      // 2
      const rno = document.querySelector("input[name='rno']").value;
      console.log("rno:", rno)
      const reply = {bno, rno}

      console.log(reply);
      e.target.closest(".modal").querySelectorAll("input[type=text]").forEach(i => reply[i.name] = i.value);
      console.log(reply)

      fetch(`/replies/${rno}`, {
        method: "PUT",
        headers : {
          "Content-Type" : "application/json"
        },
        body: JSON.stringify(reply)
      })
              .then(resp => resp.json())
              .then(data => {
                alert("댓글이 수정되었습니다")
                myModal.hide();
                loadJSONData(e);
              });
    });

  });
</script>
</html>